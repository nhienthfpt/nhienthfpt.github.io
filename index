<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <title>3D Particle Hand Interaction</title>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #0e0e11;
            font-family: system-ui, sans-serif;
        }

        #ui {
            position: fixed;
            top: 16px;
            left: 16px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            padding: 14px 16px;
            border-radius: 12px;
            color: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }

        input[type="color"] {
            width: 100%;
            height: 36px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        video {
            display: none;
        }
    </style>
</head>

<body>

    <div id="ui">
        <label>Color</label>
        <input type="color" id="colorPicker" value="#00ffff">
    </div>

    <video id="video" autoplay playsinline></video>

    <!-- THREE.JS -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>

    <!-- MEDIAPIPE -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script>
        /* =======================
           THREE.JS SETUP
        ======================= */
        const scene = new THREE.Scene();

        const camera = new THREE.PerspectiveCamera(
            60,
            window.innerWidth / window.innerHeight,
            0.1,
            1000
        );
        camera.position.z = 120;

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        /* =======================
           PARTICLES
        ======================= */
        const COUNT = 2000;
        const geometry = new THREE.BufferGeometry();
        const positions = new Float32Array(COUNT * 3);
        const spherePositions = new Float32Array(COUNT * 3);

        function generateSphere() {
            for (let i = 0; i < COUNT; i++) {
                const u = Math.random();
                const v = Math.random();
                const theta = u * Math.PI * 2;
                const phi = Math.acos(2 * v - 1);
                const r = 40;

                const x = r * Math.sin(phi) * Math.cos(theta);
                const y = r * Math.sin(phi) * Math.sin(theta);
                const z = r * Math.cos(phi);

                spherePositions[i * 3] = x;
                spherePositions[i * 3 + 1] = y;
                spherePositions[i * 3 + 2] = z;

                positions[i * 3] = x;
                positions[i * 3 + 1] = y;
                positions[i * 3 + 2] = z;
            }
        }

        generateSphere();
        geometry.setAttribute("position", new THREE.BufferAttribute(positions, 3));

        const material = new THREE.PointsMaterial({
            color: 0x00ffff,
            size: 1.4,
            transparent: true,
            opacity: 0.9
        });

        const particles = new THREE.Points(geometry, material);
        scene.add(particles);

        /* =======================
           COLOR PICKER
        ======================= */
        document.getElementById("colorPicker").addEventListener("input", e => {
            material.color.set(e.target.value);
        });

        /* =======================
           HAND TRACKING
        ======================= */
        let targetScale = 1;

        const hands = new Hands({
            locateFile: file =>
                `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 2,
            modelComplexity: 1,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.7
        });

        hands.onResults(results => {
            if (results.multiHandLandmarks?.length === 2) {
                const h1 = results.multiHandLandmarks[0][0];
                const h2 = results.multiHandLandmarks[1][0];

                const dx = h1.x - h2.x;
                const dy = h1.y - h2.y;

                const distance = Math.sqrt(dx * dx + dy * dy);

                targetScale = THREE.MathUtils.clamp(distance * 4, 0.4, 3.5);
            }
        });

        const video = document.getElementById("video");
        const cam = new Camera(video, {
            onFrame: async () => await hands.send({ image: video }),
            width: 640,
            height: 480
        });
        cam.start();

        /* =======================
           ANIMATION LOOP
        ======================= */
        function animate() {
            requestAnimationFrame(animate);

            particles.scale.lerp(
                new THREE.Vector3(targetScale, targetScale, targetScale),
                0.08
            );

            renderer.render(scene, camera);
        }
        animate();

        /* =======================
           RESIZE
        ======================= */
        window.addEventListener("resize", () => {
            camera.aspect = innerWidth / innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(innerWidth, innerHeight);
        });
    </script>

</body>

</html>

